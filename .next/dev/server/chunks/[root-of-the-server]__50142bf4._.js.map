{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 94, "column": 0}, "map": {"version":3,"sources":["file:///Users/ermuhan/Developer/NextJs/ai-course-generation/app/api/generate-topic-content/route.ts"],"sourcesContent":["// app/api/generate-topic-content/route.ts\nimport Groq from \"groq-sdk\";\n\nconst groq = new Groq({ apiKey: process.env.GROQ_API_KEY });\n\nexport async function POST(request: Request) {\n  try {\n    const { topic, course, userProfile } = await request.json();\n\n    // üîç Debug: Log the received data\n    console.log(\"=== GENERATE TOPIC CONTENT REQUEST ===\");\n    console.log(\"Target Language:\", course.targetLanguage);\n    console.log(\"Topic Title:\", topic.title);\n    console.log(\"Level:\", course.level);\n\n    const profile = userProfile ?? {\n      profession: \"Unknown\",\n      interests: [],\n    };\n\n    const userInterests = Array.isArray(profile.interests)\n      ? profile.interests\n      : [];\n    const targetLanguage = course.targetLanguage;\n\n    // üîç Debug: Confirm target language\n    console.log(\"üéØ Generating lesson in:\", targetLanguage);\n\n    const prompt = `You are a professional ${targetLanguage} language teacher. Create a complete lesson.\n\nTOPIC INFORMATION:\n- Title: ${topic.title}\n- Description: ${topic.description}\n\nSTUDENT PROFILE:\n- Profession: ${profile.profession}\n- Interests: ${userInterests.length > 0 ? userInterests.join(\", \") : \"General\"}\n- Level: ${course.level}\n\nLESSON REQUIREMENTS:\n1. Explanation (3-4 paragraphs explaining the topic)\n2. Examples (5 practical examples)\n3. Grammar rules (if applicable to this topic)\n4. Exercises (3 different types):\n   - Multiple choice question\n   - Fill-in-the-blank question\n   - Translation exercise\n5. Story (short dialog or narrative)\n\n‚ö†Ô∏è CRITICAL INSTRUCTION - READ CAREFULLY:\nThe student is learning ${targetLanguage}.\nTherefore, ALL content MUST be in ${targetLanguage} language:\n- Explanation ‚Üí write in ${targetLanguage}\n- Examples ‚Üí write in ${targetLanguage}\n- Grammar rules ‚Üí write in ${targetLanguage}\n- Exercise questions ‚Üí write in ${targetLanguage}\n- Exercise answers ‚Üí write in ${targetLanguage}\n- Story ‚Üí write in ${targetLanguage}\n\nDO NOT write in English, Uzbek, Russian, or any other language.\nONLY use ${targetLanguage} language for ALL content.\n\n${getContentExamples(targetLanguage)}\n\nReturn ONLY valid JSON:\n\n{\n  \"explanation\": \"Detailed explanation in ${targetLanguage}\",\n  \"examples\": [\n    \"Example 1 in ${targetLanguage}\",\n    \"Example 2 in ${targetLanguage}\",\n    \"Example 3 in ${targetLanguage}\",\n    \"Example 4 in ${targetLanguage}\",\n    \"Example 5 in ${targetLanguage}\"\n  ],\n  \"grammar\": \"Grammar rules in ${targetLanguage} or empty string\",\n  \"tasks\": [\n    {\n      \"id\": \"1\",\n      \"question\": \"Question in ${targetLanguage}\",\n      \"type\": \"multiple-choice\",\n      \"options\": [\"A in ${targetLanguage}\", \"B in ${targetLanguage}\", \"C in ${targetLanguage}\", \"D in ${targetLanguage}\"],\n      \"answer\": \"Correct answer in ${targetLanguage}\"\n    },\n    {\n      \"id\": \"2\",\n      \"question\": \"Question in ${targetLanguage}\",\n      \"type\": \"fill-blank\",\n      \"answer\": \"Answer in ${targetLanguage}\"\n    },\n    {\n      \"id\": \"3\",\n      \"question\": \"Question in ${targetLanguage}\",\n      \"type\": \"translate\",\n      \"answer\": \"Answer in ${targetLanguage}\"\n    }\n  ],\n  \"story\": \"Story or dialog in ${targetLanguage}\"\n}`;\n\n    console.log(\"üìù Sending prompt to Groq...\");\n\n    const response = await groq.chat.completions.create({\n      model: \"llama-3.1-8b-instant\",\n      messages: [\n        {\n          role: \"system\",\n          content: `\n            You are a professional ${targetLanguage} language teacher.\n            ALL content (module titles, descriptions, topic titles, topic descriptions, examples, tasks) MUST be in ${targetLanguage}.\n            Do NOT use English, Uzbek, Russian, or any other language.\n            Respond ONLY in VALID JSON format.\n            `,\n        },\n        { role: \"user\", content: prompt },\n      ],\n      temperature: 0.6,\n      max_tokens: 4000,\n    });\n\n    const text = response.choices[0]?.message?.content ?? \"\";\n\n    // üîç Debug: Log raw AI response\n    console.log(\n      \"ü§ñ AI Raw Response (first 500 chars):\",\n      text.substring(0, 500)\n    );\n\n    let content;\n    try {\n      const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        content = JSON.parse(jsonMatch[0]);\n      } else {\n        content = JSON.parse(text);\n      }\n    } catch (err) {\n      console.error(\"‚ùå JSON parse error:\", err);\n      console.error(\"Full AI Response:\", text);\n\n      content = {\n        explanation: `Lesson content for ${topic.title}`,\n        examples: [\n          \"Example 1\",\n          \"Example 2\",\n          \"Example 3\",\n          \"Example 4\",\n          \"Example 5\",\n        ],\n        grammar: \"\",\n        tasks: [\n          {\n            id: \"1\",\n            question: \"Question 1\",\n            type: \"multiple-choice\",\n            options: [\"A\", \"B\", \"C\", \"D\"],\n            answer: \"A\",\n          },\n          {\n            id: \"2\",\n            question: \"Question 2\",\n            type: \"fill-blank\",\n            answer: \"answer\",\n          },\n          {\n            id: \"3\",\n            question: \"Question 3\",\n            type: \"translate\",\n            answer: \"translation\",\n          },\n        ],\n        story: \"Story content\",\n      };\n    }\n\n    // Validate structure\n    if (!content.explanation) content.explanation = \"\";\n    if (!Array.isArray(content.examples)) content.examples = [];\n    if (!content.grammar) content.grammar = \"\";\n    if (!Array.isArray(content.tasks)) content.tasks = [];\n    if (!content.story) content.story = \"\";\n\n    // üîç Debug: Log generated content sample\n    console.log(\"‚úÖ Explanation length:\", content.explanation.length);\n    console.log(\"‚úÖ Examples count:\", content.examples.length);\n    console.log(\"‚úÖ First example:\", content.examples[0]);\n\n    return new Response(JSON.stringify(content), {\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  } catch (error) {\n    console.error(\"‚ùå Fatal error in generate-topic-content:\", error);\n    return new Response(\n      JSON.stringify({\n        error: \"Failed to generate topic content\",\n        details: error instanceof Error ? error.message : \"Unknown error\",\n      }),\n      { status: 500, headers: { \"Content-Type\": \"application/json\" } }\n    );\n  }\n}\n\nfunction getContentExamples(language: string): string {\n  const lower = language.toLowerCase();\n\n  if (lower.includes(\"english\") || lower.includes(\"ingliz\")) {\n    return `Example for English:\n{\n  \"explanation\": \"The present simple tense is used to describe habits, general truths, and repeated actions...\",\n  \"examples\": [\"I work every day\", \"She speaks English fluently\", \"They play football on Sundays\"],\n  \"grammar\": \"Form: Subject + base verb (+ s/es for he/she/it)\",\n  \"tasks\": [{\"question\": \"Choose the correct form: He ___ to school every day\", \"type\": \"multiple-choice\", \"options\": [\"go\", \"goes\", \"going\", \"went\"], \"answer\": \"goes\"}],\n  \"story\": \"John wakes up at 7 AM every morning. He brushes his teeth and eats breakfast...\"\n}`;\n  }\n\n  if (lower.includes(\"spanish\")) {\n    return `Ejemplo para espa√±ol:\n{\n  \"explanation\": \"El presente simple se usa para describir h√°bitos, verdades generales y acciones repetidas...\",\n  \"examples\": [\"Trabajo todos los d√≠as\", \"Ella habla ingl√©s con fluidez\", \"Ellos juegan f√∫tbol los domingos\"],\n  \"grammar\": \"Forma: Sujeto + verbo conjugado\",\n  \"tasks\": [{\"question\": \"Elige la forma correcta: √âl ___ a la escuela todos los d√≠as\", \"type\": \"multiple-choice\", \"options\": [\"ir\", \"va\", \"yendo\", \"fue\"], \"answer\": \"va\"}]\n}`;\n  }\n\n  return `Write ALL content in ${language} language.`;\n}\n"],"names":[],"mappings":"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"}}]
}